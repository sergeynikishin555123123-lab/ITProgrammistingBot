{% extends "base.html" %}

{% block title %}–£—Ä–æ–∫ {{ lesson.id }} - {{ lesson.title }}{% endblock %}

{% block content %}
<div class="lesson-container">
    <div class="lesson-sidebar">
        <h3>üìö –£—Ä–æ–∫ {{ lesson.id }}</h3>
        <h4>{{ lesson.title }}</h4>
        
        <div class="theory-section">
            {{ lesson.theory|safe }}
        </div>
        
        <div class="task-section">
            <h4>üìù –ó–∞–¥–∞–Ω–∏–µ:</h4>
            <p>{{ lesson.task }}</p>
        </div>
    </div>

    <div class="lesson-main">
        <div class="code-editor">
            <h4>üë®üíª –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞:</h4>
            <textarea id="codeInput" rows="15">{{ lesson.initial_code }}</textarea>
            <button onclick="runCode()" class="btn btn-run">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥</button>
            <button onclick="submitSolution()" class="btn btn-submit">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
        </div>

        <div class="output-section">
            <h4>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <pre id="output"></pre>
        </div>

        <div class="farm-preview">
            <h4>üè† –¢–≤–æ—è —Ñ–µ—Ä–º–∞:</h4>
            <div id="farmDisplay">
                <!-- –§–µ—Ä–º–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>
</div>

<script>
async function runCode() {
    const code = document.getElementById('codeInput').value;
    const output = document.getElementById('output');
    
    // –≠–º—É–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ - –∑–∞–ø—Ä–æ—Å –∫ API)
    output.textContent = "–í—ã–ø–æ–ª–Ω—è—é –∫–æ–¥...";
    
    // –ü—Ä–æ—Å—Ç–∞—è —ç–º—É–ª—è—Ü–∏—è –≤—ã–≤–æ–¥–∞ print
    const lines = code.split('\n');
    let result = [];
    
    for(let line of lines) {
        if(line.trim().startsWith('print(')) {
            const content = line.split('print(')[1].replace(/\)$/, '').replace(/['"]/g, '');
            result.push(content);
        }
    }
    
    output.textContent = result.join('\n');
}

async function submitSolution() {
    const code = document.getElementById('codeInput').value;
    const lessonId = {{ lesson.id }};
    
    const response = await fetch('/api/validate_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `lesson_id=${lessonId}&user_code=${encodeURIComponent(code)}`
    });
    
    const result = await response.json();
    
    if(result.success) {
        alert(result.message);
        if(result.farm_updated) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–µ—Ä–º—ã
            updateFarmDisplay();
        }
    } else {
        alert(result.message);
    }
}

function updateFarmDisplay() {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ - –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ñ–µ—Ä–º—ã
    const farmDisplay = document.getElementById('farmDisplay');
    farmDisplay.innerHTML = '<div class="farm-updated">‚úÖ –§–µ—Ä–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞! –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–∞ —Ç–≤–æ–µ–π —Ñ–µ—Ä–º–µ!</div>';
}
</script>
{% endblock %}
