{% extends "base.html" %}

{% block content %}
<div class="telegram-app">
    <div class="app-header">
        <div class="user-info">
            <div class="avatar">üöú</div>
            <div class="user-details">
                <h3 id="username">–§–µ—Ä–º–µ—Ä</h3>
                <div class="stats">
                    <span class="level">–£—Ä–æ–≤–µ–Ω—å: <span id="userLevel">1</span></span>
                    <span class="coins">üí∞ <span id="userCoins">100</span></span>
                    <span class="exp">‚≠ê <span id="userExp">0/100</span></span>
                </div>
            </div>
        </div>
        
        <div class="app-controls">
            <button onclick="showLessons()" class="btn-lessons">üìö –£—Ä–æ–∫–∏</button>
            <button onclick="showFarm()" class="btn-farm">üè† –§–µ—Ä–º–∞</button>
        </div>
    </div>

    <div class="app-content" id="appContent">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        <div class="welcome-screen">
            <h2>üöú –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ CodeFarm!</h2>
            <p>–¢–≤–æ—è —Ñ–µ—Ä–º–∞ –∂–¥–µ—Ç —Å–≤–æ–µ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞!</p>
            
            <div class="quick-stats">
                <div class="stat-card">
                    <h4>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</h4>
                    <p>–ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤: <span id="completedCount">0</span>/<span id="totalLessons">50</span></p>
                </div>
                <div class="stat-card">
                    <h4>üéØ –¶–µ–ª—å</h4>
                    <p>–°—Ç–∞—Ç—å Junior Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º</p>
                </div>
            </div>
            
            <div class="start-buttons">
                <button onclick="startLesson(1)" class="btn-start-lesson">
                    üöÄ –ù–∞—á–∞—Ç—å –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫
                </button>
                <button onclick="showFarm()" class="btn-view-farm">
                    üè† –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–µ—Ä–º—É
                </button>
            </div>
            
            <div class="recent-lessons">
                <h4>üìö –ù–µ–¥–∞–≤–Ω–∏–µ —É—Ä–æ–∫–∏</h4>
                <div class="lessons-list" id="recentLessons">
                    <!-- –£—Ä–æ–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–ª—É—á–∞–µ–º session_token –∏–∑ URL –∏–ª–∏ localStorage
const urlParams = new URLSearchParams(window.location.search);
const sessionToken = urlParams.get('startapp') || localStorage.getItem('codefarm_session');

if (sessionToken) {
    localStorage.setItem('codefarm_session', sessionToken);
    loadUserProgress();
}

async function loadUserProgress() {
    try {
        const response = await fetch(`/api/user_progress?session_token=${sessionToken}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('username').textContent = data.user.username;
            document.getElementById('userLevel').textContent = data.user.level;
            document.getElementById('userCoins').textContent = data.user.coins;
            document.getElementById('userExp').textContent = `${data.user.experience}/100`;
            document.getElementById('completedCount').textContent = data.progress.completed_lessons.length;
            document.getElementById('totalLessons').textContent = data.progress.total_lessons;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ —É—Ä–æ–∫–∏
            showRecentLessons(data.progress.completed_lessons);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
    }
}

function showRecentLessons(completedLessons) {
    const lessonsContainer = document.getElementById('recentLessons');
    lessonsContainer.innerHTML = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞
    const recent = completedLessons.slice(-3).reverse();
    
    recent.forEach(lessonId => {
        const lessonDiv = document.createElement('div');
        lessonDiv.className = 'lesson-item completed';
        lessonDiv.innerHTML = `
            <span>‚úÖ –£—Ä–æ–∫ ${lessonId}</span>
            <button onclick="startLesson(${lessonId})" class="btn-review">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        `;
        lessonsContainer.appendChild(lessonDiv);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
    const nextLesson = completedLessons.length + 1;
    const nextDiv = document.createElement('div');
    nextDiv.className = 'lesson-item next';
    nextDiv.innerHTML = `
        <span>üéØ –£—Ä–æ–∫ ${nextLesson} (–°–ª–µ–¥—É—é—â–∏–π)</span>
        <button onclick="startLesson(${nextLesson})" class="btn-start">–ù–∞—á–∞—Ç—å</button>
    `;
    lessonsContainer.appendChild(nextDiv);
}

function startLesson(lessonId) {
    window.location.href = `/lesson/${lessonId}?session_token=${sessionToken}`;
}

function showLessons() {
    window.location.href = `/lessons?session_token=${sessionToken}`;
}

function showFarm() {
    // –í –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ñ–µ—Ä–º—ã
    alert('–§–µ—Ä–º–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏! –ü–æ–∫–∞ —á—Ç–æ —É—á–∏—Å—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å! üöÄ');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    if (!sessionToken) {
        document.getElementById('appContent').innerHTML = `
            <div class="error-screen">
                <h2>‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
                <p>–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CodeFarm, –Ω–∞—á–Ω–∏ —Å Telegram –±–æ—Ç–∞:</p>
                <ol>
                    <li>–ù–∞–π–¥–∏ @CodeFarmBot –≤ Telegram</li>
                    <li>–ù–∞–∂–º–∏ /start</li>
                    <li>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "üöÄ –û—Ç–∫—Ä—ã—Ç—å CodeFarm"</li>
                </ol>
                <p>–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏ –Ω–∞–ø—Ä—è–º—É—é: <a href="https://t.me/CodeFarmBot" target="_blank">@CodeFarmBot</a></p>
            </div>
        `;
    }
});
</script>

<style>
.telegram-app {
    max-width: 100%;
    margin: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: white;
}

.app-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.avatar {
    font-size: 2.5rem;
    background: rgba(255, 255, 255, 0.2);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.user-details h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
}

.stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.app-controls {
    display: flex;
    gap: 0.5rem;
}

.btn-lessons, .btn-farm {
    flex: 1;
    padding: 0.75rem;
    border: none;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-lessons:hover, .btn-farm:hover {
    background: rgba(255, 255, 255, 0.3);
}

.app-content {
    padding: 1rem;
}

.welcome-screen h2 {
    text-align: center;
    margin-bottom: 0.5rem;
}

.welcome-screen > p {
    text-align: center;
    opacity: 0.9;
    margin-bottom: 2rem;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
}

.stat-card h4 {
    margin: 0 0 0.5rem 0;
}

.start-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
}

.btn-start-lesson, .btn-view-farm {
    padding: 1rem;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: transform 0.3s;
}

.btn-start-lesson {
    background: #2ecc71;
    color: white;
}

.btn-view-farm {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.btn-start-lesson:hover, .btn-view-farm:hover {
    transform: translateY(-2px);
}

.recent-lessons h4 {
    margin-bottom: 1rem;
}

.lessons-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.lesson-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.75rem;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.lesson-item.completed {
    border-left: 4px solid #2ecc71;
}

.lesson-item.next {
    border-left: 4px solid #f39c12;
}

.btn-review, .btn-start {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-review {
    background: rgba(46, 204, 113, 0.3);
    color: white;
}

.btn-start {
    background: #f39c12;
    color: white;
}

.error-screen {
    text-align: center;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    margin-top: 2rem;
}

.error-screen ol {
    text-align: left;
    display: inline-block;
    margin: 1rem 0;
}

.error-screen a {
    color: #2ecc71;
    text-decoration: none;
}
</style>
{% endblock %}
