<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>БАНЯ | Личный кабинет</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        
        :root {
            --blue-primary: #0066FF;
            --blue-dark: #0052CC;
            --blue-light: #4D94FF;
            --blue-bright: #3399FF;
            --blue-pale: #E6F2FF;
            --pink: #FF3366;
            --white: #FFFFFF;
            --gray-light: #F5F7FA;
            --gray-medium: #E1E5EB;
            --gray-dark: #7F8C8D;
            --success: #28A745;
            --error: #DC3545;
            --warning: #FFC107;
            --shadow: 0 4px 12px rgba(0, 102, 255, 0.15);
        }

        @font-face {
            font-family: 'BanyaFont';
            src: url('https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxK.woff2');
            font-weight: 400;
        }

        @font-face {
            font-family: 'BanyaFont';
            src: url('https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBBc4.woff2');
            font-weight: 700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'BanyaFont', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--white);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* СТРАНИЦА АВТОРИЗАЦИИ */
        #auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--blue-pale) 0%, var(--white) 100%);
        }

        .auth-container {
            max-width: 400px;
            width: 100%;
            background: var(--white);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: var(--shadow);
            border: 2px solid var(--blue-primary);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--blue-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--blue-primary), var(--blue-bright));
        }

        .auth-logo-text {
            font-family: 'BanyaFont';
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--blue-primary);
            margin-bottom: 5px;
        }

        .auth-subtitle {
            font-size: 1rem;
            color: var(--gray-dark);
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--blue-primary);
            text-align: center;
            margin-bottom: 20px;
        }

        .phone-form {
            margin-bottom: 25px;
        }

        .phone-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 8px;
        }

        .phone-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--blue-primary);
            border-radius: 12px;
            font-size: 1.1rem;
            color: #333;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .phone-input:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 0 3px rgba(255, 51, 102, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 30px;
            border: 2px solid var(--blue-primary);
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
            background: var(--blue-primary);
            color: var(--white);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--blue-primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--blue-dark);
            border-color: var(--blue-dark);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--blue-primary);
        }

        .btn-secondary:hover {
            background: var(--blue-primary);
            color: var(--white);
        }

        .btn-pink {
            background: var(--pink);
            color: var(--white);
            border-color: var(--pink);
        }

        .btn-pink:hover {
            background: #ff1a53;
            border-color: #ff1a53;
        }

        .auth-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--gray-medium);
            text-align: center;
            color: var(--gray-dark);
            font-size: 0.9rem;
        }

        /* ОСНОВНОЙ ИНТЕРФЕЙС */
        .app-container {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        /* ВЕРХНИЙ БАР */
        .top-bar {
            background: var(--blue-primary);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 102, 255, 0.2);
        }

        .logo-text {
            font-family: 'BanyaFont';
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }

        .top-bar-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .top-bar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .top-bar-change-student {
            background: var(--white);
            color: var(--blue-primary);
            border-color: var(--white);
        }

        .top-bar-change-student:hover {
            background: var(--blue-dark);
            color: var(--white);
            border-color: var(--white);
        }

        .top-bar-logout {
            background: transparent;
            color: var(--white);
            border-color: var(--white);
        }

        .top-bar-logout:hover {
            background: var(--white);
            color: var(--error);
        }

        /* НИЖНЯЯ НАВИГАЦИЯ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: var(--white);
            border-top: 2px solid var(--blue-primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 102, 255, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-dark);
            text-decoration: none;
            padding: 8px 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            width: 70px;
            height: 55px;
            min-width: 0;
        }

        .nav-item.active {
            color: var(--blue-primary);
            background: var(--blue-pale);
            transform: translateY(-3px);
        }

        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* ОСНОВНОЙ КОНТЕНТ */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            background: var(--white);
        }

        /* ВЫБОР УЧЕНИКА - МОДАЛЬНОЕ ОКНО */
        .student-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .student-selector-modal.active {
            display: flex;
        }

        .student-selector-container {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--blue-primary);
            box-shadow: var(--shadow);
        }

        .selector-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-medium);
        }

        .students-list-modal {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-item-modal {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--blue-pale);
            border-radius: 12px;
            border: 2px solid var(--blue-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .student-item-modal:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .student-item-modal.active {
            background: var(--blue-primary);
            color: var(--white);
        }

        .student-info-modal {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .student-avatar-modal {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--blue-primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .student-item-modal.active .student-avatar-modal {
            background: var(--white);
            color: var(--blue-primary);
        }

        .student-details-modal {
            flex: 1;
            min-width: 0;
        }

        .student-name-modal {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-branch-modal {
            font-size: 0.85rem;
            color: var(--blue-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-item-modal.active .student-branch-modal {
            color: var(--blue-pale);
        }

        .student-status-modal {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 10px;
        }

        .status-active-modal {
            background: var(--success);
            color: white;
        }

        .status-expired-modal {
            background: var(--error);
            color: white;
        }

        .close-selector-btn {
            margin-top: 20px;
            padding: 12px;
            background: var(--white);
            color: var(--blue-primary);
            border: 2px solid var(--blue-primary);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
        }

        .close-selector-btn:hover {
            background: var(--blue-primary);
            color: var(--white);
        }

        /* ГЛАВНАЯ СТРАНИЦА */
        .welcome-card {
            background: linear-gradient(135deg, var(--blue-primary), var(--blue-bright));
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            box-shadow: var(--shadow);
        }

        .greeting {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .student-greeting-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .student-details-info {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        /* БЫСТРЫЕ КАРТОЧКИ */
        .quick-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--blue-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .quick-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .quick-card-icon {
            width: 50px;
            height: 50px;
            background: var(--blue-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .quick-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 5px;
        }

        .quick-card-desc {
            font-size: 0.8rem;
            color: var(--gray-dark);
        }

        /* СЕКЦИИ */
        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--pink);
        }

        /* КАРТОЧКИ */
        .card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--blue-primary);
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        /* СТРАНИЦА РАСПИСАНИЯ */
        .schedule-day {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--blue-primary);
        }

        .day-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-medium);
        }

        .lesson-item {
            padding: 15px;
            background: var(--blue-pale);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--blue-primary);
        }

        .lesson-item.cancelled {
            border-left-color: var(--error);
            opacity: 0.7;
        }

        .lesson-time {
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 5px;
        }

        .lesson-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .lesson-teacher {
            font-size: 0.9rem;
            color: var(--blue-dark);
        }

        .lesson-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-normal {
            background: var(--success);
            color: white;
        }

        .status-cancelled {
            background: var(--error);
            color: white;
        }

        /* СТРАНИЦА АБОНЕМЕНТА */
        .subscription-card {
            background: linear-gradient(135deg, var(--blue-primary), var(--blue-bright));
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .subscription-type {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .subscription-branch {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .subscription-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--white);
            border-radius: 5px;
        }

        .dates-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .date-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
        }

        .date-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .date-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ИСТОРИЯ ПОСЕЩЕНИЙ НА СТРАНИЦЕ АБОНЕМЕНТА */
        .visits-history-window {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--blue-primary);
            box-shadow: var(--shadow);
        }

        .visits-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-medium);
        }

        .visits-history-header i {
            color: var(--blue-primary);
            font-size: 1.3rem;
            margin-right: 10px;
        }

        .visits-history-header span {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--blue-primary);
        }

        /* СТАТИСТИКА ПОСЕЩЕНИЙ - УБРАТЬ ЭТОТ БЛОК */
        /* .visits-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .visit-stat-card {
            background: var(--blue-pale);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--blue-primary);
        }

        .visit-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blue-primary);
            margin-bottom: 5px;
        }

        .visit-stat-label {
            font-size: 0.8rem;
            color: var(--blue-dark);
            font-weight: 600;
        } */

        /* СПИСОК ПОСЕЩЕНИЙ */
        .visits-list-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .visits-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .visits-list-container::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 3px;
        }

        .visits-list-container::-webkit-scrollbar-thumb {
            background: var(--blue-primary);
            border-radius: 3px;
        }

        .visit-item {
            background: var(--blue-pale);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--success);
            transition: all 0.3s ease;
        }

        .visit-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .visit-item.estimated {
            border-left-color: var(--warning);
        }

        .visit-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visit-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .visit-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--blue-dark);
        }

        .visit-detail i {
            color: var(--blue-primary);
            width: 16px;
            text-align: center;
        }

        /* ПАГИНАЦИЯ */
        .visits-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-medium);
        }

        .pagination-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid var(--blue-primary);
            background: var(--white);
            color: var(--blue-primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--blue-primary);
            color: white;
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* СТРАНИЦА ПРЕПОДАВАТЕЛЕЙ */
        .teachers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .teacher-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--blue-primary);
            text-align: center;
            transition: all 0.3s ease;
        }

        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .teacher-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--blue-primary), var(--blue-bright));
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
        }

        .teacher-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 5px;
        }

        .teacher-branch {
            font-size: 0.8rem;
            color: var(--blue-dark);
            margin-bottom: 10px;
        }

        .teacher-specialization {
            font-size: 0.9rem;
            color: var(--blue-primary);
            font-style: italic;
        }

        /* СТРАНИЦА FAQ */
        .faq-list {
            background: var(--white);
            border-radius: 15px;
            border: 2px solid var(--blue-primary);
            overflow: hidden;
        }

        .faq-item {
            border-bottom: 2px solid var(--gray-medium);
            overflow: hidden;
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-question {
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--blue-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            transition: background 0.3s ease;
        }

        .faq-question:hover {
            background: var(--blue-pale);
        }

        .faq-question i {
            transition: transform 0.3s ease;
        }

        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--blue-pale);
            font-size: 1rem;
            line-height: 1.6;
        }

        .faq-item.active .faq-answer {
            padding: 20px;
            max-height: 500px;
        }

        /* СТРАНИЦА НОВОСТЕЙ */
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .news-item {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--blue-primary);
            transition: all 0.3s ease;
        }

        .news-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .news-date {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-bottom: 10px;
        }

        .news-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 10px;
        }

        .news-content {
            font-size: 1rem;
            color: #333;
            line-height: 1.6;
        }

        .news-content-short {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* СТРАНИЦА КОНТАКТОВ */
        .contact-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .contact-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--blue-primary);
            text-align: center;
        }

        .contact-icon {
            width: 60px;
            height: 60px;
            background: var(--blue-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin: 0 auto 15px;
        }

        .contact-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--blue-primary);
            margin-bottom: 10px;
        }

        .contact-info {
            font-size: 1rem;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .contact-hours {
            font-size: 0.9rem;
            color: var(--gray-dark);
            margin-bottom: 20px;
        }

        /* УВЕДОМЛЕНИЯ */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 3000;
            background: var(--white);
            border-radius: 12px;
            padding: 15px 20px;
            border: 2px solid var(--blue-primary);
            animation: slideIn 0.3s ease;
            max-width: 90%;
            width: 350px;
            box-shadow: var(--shadow);
        }

        .notification.error {
            border-color: var(--error);
            color: var(--error);
        }

        .notification.success {
            border-color: var(--success);
            color: var(--success);
        }

        .notification.warning {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* СПИННЕР */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--blue-pale);
            border-top: 3px solid var(--blue-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* АНИМАЦИИ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .quick-cards {
                grid-template-columns: 1fr;
            }
            
            .subscription-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .dates-info {
                grid-template-columns: 1fr;
            }
            
            .teachers-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* .visits-stats {
                grid-template-columns: repeat(2, 1fr);
            } */
            
            .top-bar {
                padding: 12px 15px;
            }
            
            .main-content {
                padding: 15px;
                padding-bottom: 75px;
            }
            
            .notification {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .bottom-nav {
                height: 60px;
            }
            
            .nav-item {
                width: 65px;
                height: 50px;
                padding: 6px 8px;
            }
            
            .nav-item i {
                font-size: 1.2rem;
            }
            
            .nav-item span {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 30px 20px;
            }
            
            .auth-logo-text {
                font-size: 2rem;
            }
            
            .teachers-grid {
                grid-template-columns: 1fr;
            }
            
            /* .visits-stats {
                grid-template-columns: 1fr;
            } */
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .bottom-nav {
                height: 55px;
            }
            
            .nav-item {
                width: 60px;
                height: 45px;
            }
            
            .nav-item i {
                font-size: 1.1rem;
                margin-bottom: 3px;
            }
            
            .nav-item span {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 360px) {
            .nav-item {
                width: 55px;
                padding: 5px;
            }
            
            .nav-item span {
                font-size: 0.55rem;
            }
        }

        /* УТИЛИТЫ */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-dark);
            border: 2px dashed var(--gray-medium);
            border-radius: 15px;
            background: var(--white);
            margin: 20px 0;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--blue-primary);
            margin-bottom: 15px;
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .w-100 { width: 100%; }
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .d-block { display: block !important; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .flex-wrap { flex-wrap: wrap; }

        /* БЕЙДЖИ */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--blue-primary);
            color: white;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-error {
            background: var(--error);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-pink {
            background: var(--pink);
            color: white;
        }

        /* КНОПКА НАЗАД */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--white);
            border: 2px solid var(--blue-primary);
            border-radius: 12px;
            color: var(--blue-primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--blue-primary);
            color: white;
            transform: translateX(-5px);
        }

        /* ЗАГОЛОВКИ СТРАНИЦ */
        .page-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--blue-primary);
            flex: 1;
        }

        /* СКРЫТЫЕ ЭЛЕМЕНТЫ */
        .page-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page-section.active {
            display: block;
        }
/* НОВЫЕ СТИЛИ ДЛЯ ИНФОРМАЦИИ ОБ АБОНЕМЕНТЕ В СПИСКЕ УЧЕНИКОВ */
.student-subscription-modal {
    font-size: 0.8rem;
    color: var(--gray-dark);
    margin-top: 3px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Выделение активного ученика */
.student-item-modal.active {
    border-left: 4px solid var(--blue-primary);
    background-color: rgba(0, 102, 255, 0.05);
}

/* Улучшение отображения дат в абонементе */
.date-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.date-item:last-child {
    border-bottom: none;
}

.date-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.date-value {
    color: white;
    font-weight: 500;
    font-size: 0.95rem;
}
        /* СЕТКА ФИЛЬТРОВ */
        .branch-badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--blue-primary);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* ПУСТОЕ СОСТОЯНИЕ */
        .visits-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-dark);
        }

        .visits-empty-state i {
            font-size: 3rem;
            color: var(--blue-primary);
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- ЗАГРУЗКА -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Загрузка...</div>
    </div>
    
    <!-- СТРАНИЦА АВТОРИЗАЦИИ -->
    <div id="auth-page">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="logo-image" id="authLogo">Б</div>
                <div class="auth-logo-text">БАНЯ</div>
                <div class="auth-subtitle">Школа рисования</div>
            </div>
            
            <h2 class="auth-title">Вход в личный кабинет</h2>
            
            <div class="phone-form">
                <div class="phone-label">Номер телефона</div>
                <input type="tel" id="phoneNumber" class="phone-input" placeholder="7 999 123-45-67" required>
                <div style="font-size: 0.8rem; color: var(--gray-dark); margin-top: 5px;">
                    Введите номер, указанный при оформлении абонемента
                </div>
            </div>
            
            <button class="btn btn-primary" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                Войти
            </button>
            
            <div class="auth-footer">
                <i class="fas fa-info-circle"></i>
                <div>Для связи: +7 (999) 123-45-67</div>
            </div>
        </div>
    </div>
    
    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div class="app-container" id="appContainer">
        <!-- ВЕРХНИЙ БАР -->
        <nav class="top-bar">
            <div class="logo-text">БАНЯ</div>
            
            <div class="top-bar-buttons">
                <button class="top-bar-btn top-bar-change-student" onclick="BanyaApp.showStudentsSelectorModal()">
                    <i class="fas fa-users"></i>
                    <span class="hide-on-mobile">Сменить ученика</span>
                </button>
                <button class="top-bar-btn top-bar-logout" onclick="BanyaApp.logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="hide-on-mobile">Выйти</span>
                </button>
            </div>
        </nav>
        
        <!-- ОСНОВНОЙ КОНТЕНТ -->
        <main class="main-content" id="mainContent">
            <!-- ГЛАВНАЯ СТРАНИЦА -->
            <section id="homePage" class="page-section active">
                <div class="welcome-card" id="welcomeCard">
                    <div class="greeting" id="greeting">Добро пожаловать</div>
                    <div class="student-greeting-name" id="studentGreetingName">Загрузка...</div>
                    <div class="student-details-info" id="studentDetailsInfo">
                        Загрузка информации об ученике...
                    </div>
                </div>
                
                <div class="quick-cards">
                    <div class="quick-card" onclick="BanyaApp.navigateTo('subscription')">
                        <div class="quick-card-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="quick-card-title">Абонемент</div>
                        <div class="quick-card-desc">Остаток занятий и срок действия</div>
                    </div>
                    
                    <div class="quick-card" onclick="BanyaApp.navigateTo('schedule')">
                        <div class="quick-card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="quick-card-title">Расписание</div>
                        <div class="quick-card-desc">Ваши занятия на неделю</div>
                    </div>
                    
                    <div class="quick-card" onclick="BanyaApp.navigateTo('teachers')">
                        <div class="quick-card-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="quick-card-title">Преподаватели</div>
                        <div class="quick-card-desc">Наши педагоги и их регалии</div>
                    </div>
                    
                    <div class="quick-card" onclick="BanyaApp.navigateTo('news')">
                        <div class="quick-card-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <div class="quick-card-title">Новости</div>
                        <div class="quick-card-desc">Акции и мероприятия школы</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3 class="section-title">
                        <i class="fas fa-fire"></i> Быстрый доступ
                    </h3>
                    
                    <div class="card" onclick="BanyaApp.navigateTo('faq')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; background: var(--blue-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--blue-primary); margin-bottom: 5px;">Частые вопросы</div>
                                <div style="font-size: 0.9rem; color: var(--gray-dark);">Ответы на популярные вопросы</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" onclick="BanyaApp.navigateTo('contact')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; background: var(--blue-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--blue-primary); margin-bottom: 5px;">Связаться с администратором</div>
                                <div style="font-size: 0.9rem; color: var(--gray-dark);">Задать вопрос или продлить абонемент</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- РАСПИСАНИЕ -->
            <section id="schedulePage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Расписание</h2>
                </div>
                
                <div id="branchBadge" style="display: none;" class="branch-badge">
                    <!-- Филиал будет показан здесь -->
                </div>
                
                <div id="scheduleContainer">
                    <!-- Расписание будет загружено динамически -->
                </div>
            </section>
            
            <!-- АБОНЕМЕНТ -->
            <section id="subscriptionPage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Мой абонемент</h2>
                    <button class="btn btn-secondary" onclick="BanyaApp.refreshSubscription()" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div id="subscriptionContainer">
                    <!-- Абонемент будет загружен динамически -->
                </div>
                
                <!-- ИСТОРИЯ ПОСЕЩЕНИЙ - ОКОШКО НА СТРАНИЦЕ АБОНЕМЕНТА -->
                <div class="visits-history-window" id="visitsHistoryWindow" style="display: none;">
                    <div class="visits-history-header">
                        <div>
                            <i class="fas fa-history"></i>
                            <span>История посещений</span>
                        </div>
                        <button class="btn btn-secondary" onclick="BanyaApp.refreshVisitsHistory()" style="width: auto; padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                    </div>
                    
                    <!-- Статистика посещений - БЛОК УБРАН -->
                    
                    <!-- Список посещений -->
                    <div class="visits-list-container" id="visitsListContainer">
                        <!-- Посещения будут загружены здесь -->
                    </div>
                    
                    <!-- Пагинация (если много посещений) -->
                    <div class="visits-pagination" id="visitsPagination" style="display: none;">
                        <button class="pagination-btn" onclick="BanyaApp.prevVisitsPage()" id="prevVisitsPageBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="visitsPageInfo">Страница 1 из 1</span>
                        <button class="pagination-btn" onclick="BanyaApp.nextVisitsPage()" id="nextVisitsPageBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mt-30">
                    <button class="btn btn-pink w-100" onclick="BanyaApp.contactAdmin('Продлить абонемент')">
                        <i class="fas fa-credit-card"></i>
                        Продлить абонемент
                    </button>
                </div>
            </section>
            
            <!-- ПРЕПОДАВАТЕЛЕЙ -->
            <section id="teachersPage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Преподаватели</h2>
                </div>
                
                <div id="branchBadgeTeachers" style="display: none;" class="branch-badge">
                    <!-- Филиал будет показан здесь -->
                </div>
                
                <div class="teachers-grid" id="teachersContainer">
                    <!-- Преподаватели будут загружены динамически -->
                </div>
            </section>
            
            <!-- FAQ -->
            <section id="faqPage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Частые вопросы</h2>
                </div>
                
                <div class="faq-list" id="faqContainer">
                    <!-- FAQ будет загружен динамически -->
                </div>
            </section>
            
            <!-- НОВОСТИ -->
            <section id="newsPage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Новости школы</h2>
                </div>
                
                <div id="branchBadgeNews" style="display: none;" class="branch-badge">
                    <!-- Филиал будет показан здесь -->
                </div>
                
                <div class="news-list" id="newsContainer">
                    <!-- Новости будут загружены динамически -->
                </div>
            </section>
            
            <!-- КОНТАКТЫ -->
            <section id="contactPage" class="page-section">
                <div class="page-header">
                    <div class="back-button" onclick="BanyaApp.navigateTo('home')">
                        <i class="fas fa-arrow-left"></i> Назад
                    </div>
                    <h2 class="page-title">Связаться с нами</h2>
                </div>
                
                <div class="contact-cards">
                    <div class="contact-card">
                        <div class="contact-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="contact-title">Написать администратору</h3>
                        <div class="contact-info">
                            Ответим на ваши вопросы, поможем с продлением абонемента
                        </div>
                        <button class="btn btn-primary w-100" onclick="BanyaApp.contactAdmin('Вопрос по абонементу')">
                            <i class="fas fa-paper-plane"></i> Написать сообщение
                        </button>
                    </div>
                    
                    <div class="contact-card">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <h3 class="contact-title">Позвонить</h3>
                        <div class="contact-info" id="phoneInfo">
                            Загрузка контактной информации...
                        </div>
                        <div class="contact-hours">
                            Пн-Пт: 9:00-20:00<br>
                            Сб-Вс: 10:00-18:00
                        </div>
                        <button class="btn btn-secondary w-100" onclick="BanyaApp.callAdmin()">
                            <i class="fas fa-phone"></i> Позвонить
                        </button>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- НИЖНЯЯ НАВИГАЦИЯ -->
        <nav class="bottom-nav" id="bottomNav">
            <a href="#" class="nav-item active" data-page="home" onclick="BanyaApp.navigateTo('home'); return false;">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="#" class="nav-item" data-page="schedule" onclick="BanyaApp.navigateTo('schedule'); return false;">
                <i class="fas fa-calendar-alt"></i>
                <span>Расписание</span>
            </a>
            <a href="#" class="nav-item" data-page="subscription" onclick="BanyaApp.navigateTo('subscription'); return false;">
                <i class="fas fa-ticket-alt"></i>
                <span>Абонемент</span>
            </a>
            <a href="#" class="nav-item" data-page="teachers" onclick="BanyaApp.navigateTo('teachers'); return false;">
                <i class="fas fa-chalkboard-teacher"></i>
                <span>Преподаватели</span>
            </a>
            <a href="#" class="nav-item" data-page="contact" onclick="BanyaApp.navigateTo('contact'); return false;">
                <i class="fas fa-headset"></i>
                <span>Контакты</span>
            </a>
        </nav>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ВЫБОРА УЧЕНИКА -->
    <div id="studentSelectorModal" class="student-selector-modal">
        <div class="student-selector-container">
            <div class="selector-title">
                <i class="fas fa-users"></i>
                Выберите ученика
            </div>
            <div class="students-list-modal" id="studentsListModal">
                <!-- Список учеников будет здесь -->
            </div>
            <div class="close-selector-btn" onclick="BanyaApp.hideStudentsSelectorModal()">
                Закрыть
            </div>
        </div>
    </div>
    
    <!-- УВЕДОМЛЕНИЯ -->
    <div id="notificationContainer"></div>

    <script>
    const BanyaApp = {
        config: {
            API_BASE_URL: window.location.origin,
            currentUser: null,
            currentProfile: null,
            profiles: [],
            token: null,
            subscriptionData: null,
            currentPage: 'home',
            notificationInterval: null,
            branchContacts: {
                'Свиблово': '+7 (999) 123-45-67',
                'Чертаново': '+7 (999) 987-65-43',
                'all': '+7 (999) 111-22-33'
            }
        },
        
        visitsHistory: {
            visits: [],
            currentPage: 1,
            itemsPerPage: 5,
            totalPages: 1
        },

        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        init: function() {
            console.log('🎨 Инициализация приложения БАНЯ...');
            this.setupEventListeners();
            this.loadAppLogo();
            this.loadSession();
            this.checkAuthState();
        },

        // ПРОВЕРКА СОСТОЯНИЯ АВТОРИЗАЦИИ
        checkAuthState: function() {
            if (this.config.token && this.config.currentUser) {
                this.showMainInterface();
                this.navigateToPage('home');
                this.loadHomePage();
            } else {
                this.showAuthPage();
            }
        },

        // ПОКАЗАТЬ СТРАНИЦУ АВТОРИЗАЦИИ
        showAuthPage: function() {
            document.getElementById('auth-page').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        },

        // ПОКАЗАТЬ ОСНОВНОЙ ИНТЕРФЕЙС
        showMainInterface: function() {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        },

        // ПОКАЗАТЬ МОДАЛЬНОЕ ОКНО ВЫБОРА УЧЕНИКА
       // ОБНОВЛЕННЫЙ МЕТОД ПОКАЗА МОДАЛЬНОГО ОКНА
showStudentsSelectorModal: function() {
    const modal = document.getElementById('studentSelectorModal');
    const container = document.getElementById('studentsListModal');
    
    if (!this.config.profiles || this.config.profiles.length === 0) {
        this.showNotification('Нет данных об учениках', 'warning');
        return;
    }
    
    if (this.config.profiles.length === 1) {
        this.showNotification('У вас только один ученик', 'info');
        return;
    }
    
    container.innerHTML = '';
    
    this.config.profiles.forEach((profile, index) => {
        const isActive = this.config.currentProfile && 
                       this.config.currentProfile.student_name === profile.student_name;
        
        const studentItem = document.createElement('div');
        studentItem.className = `student-item-modal ${isActive ? 'active' : ''}`;
        studentItem.dataset.studentName = profile.student_name;
        studentItem.dataset.phoneNumber = profile.phone_number; // ← ДОБАВЛЕНО: телефон
        
        // Отображаем абонемент ученика в списке
        const subscriptionText = profile.subscription_type || 'Без абонемента';
        const remainingText = profile.remaining_classes > 0 ? 
            ` (осталось ${profile.remaining_classes} занятий)` : '';
        
        studentItem.innerHTML = `
            <div class="student-info-modal">
                <div class="student-avatar-modal">
                    ${this.getInitials(profile.student_name)}
                </div>
                <div class="student-details-modal">
                    <div class="student-name-modal">${profile.student_name || 'Не указано'}</div>
                    <div class="student-branch-modal">${profile.branch || 'Филиал не указан'}</div>
                    <!-- ДОБАВЛЕНА ИНФОРМАЦИЯ ОБ АБОНЕМЕНТЕ -->
                    <div class="student-subscription-modal">
                        <small>${subscriptionText}${remainingText}</small>
                    </div>
                </div>
            </div>
            <div class="student-status-modal ${profile.subscription_active === 1 ? 'status-active-modal' : 'status-expired-modal'}">
                ${profile.subscription_active === 1 ? 'Активен' : 'Не активен'}
            </div>
        `;
        
        studentItem.addEventListener('click', () => {
            const studentName = studentItem.dataset.studentName;
            
            this.selectStudent(studentName);
            this.refreshProfileData(studentName); // ← ДОБАВЛЕНО: загружаем свежие данные
            this.hideStudentsSelectorModal();
        });
        
        container.appendChild(studentItem);
    });
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
},
        // СКРЫТЬ МОДАЛЬНОЕ ОКНО ВЫБОРА УЧЕНИКА
        hideStudentsSelectorModal: function() {
            const modal = document.getElementById('studentSelectorModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        },

        // ВХОД ПО ТЕЛЕФОНУ
        handlePhoneLogin: function() {
            const phoneInput = document.getElementById('phoneNumber');
            const loginBtn = document.getElementById('loginBtn');
            
            let phone = phoneInput.value.replace(/\D/g, '');
            
            if (!phone || phone.length < 10) {
                this.showNotification('Введите корректный номер телефона (минимум 10 цифр)', 'error');
                return;
            }
            
            console.log(`📱 Авторизация по телефону: ${phone}`);
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';
            this.showLoading('Выполняется вход...');
            
            fetch('/api/auth/phone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ phone: phone })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Ученики не найдены');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Ответ сервера:', data);
                
                if (data.success && data.data && data.data.profiles) {
                    console.log('✅ Авторизация успешна!');
                    
                    this.config.token = data.data.token;
                    this.config.currentUser = data.data.user;
                    this.config.profiles = data.data.profiles;
                    this.config.currentProfile = this.config.profiles[0];
                    
                   this.config.subscriptionData = {
    student: {
        name: this.config.currentProfile.student_name,
        branch: this.config.currentProfile.branch,
        teacher_name: this.config.currentProfile.teacher_name,
        age_group: this.config.currentProfile.age_group,
        parent_name: this.config.currentProfile.parent_name,
        phone_number: this.config.currentProfile.phone_number  // ← ДОБАВЛЕНО
    },
    subscription: {
        type: this.config.currentProfile.subscription_type,
        status: this.config.currentProfile.subscription_status,
        active: this.config.currentProfile.subscription_active === 1, // ← ИСПРАВЛЕНО
        badge: this.config.currentProfile.subscription_badge,
        classes: {
            total: this.config.currentProfile.total_classes,
            used: this.config.currentProfile.used_classes,
            remaining: this.config.currentProfile.remaining_classes,
            progress: this.config.currentProfile.total_classes > 0 ? 
                Math.round((this.config.currentProfile.used_classes / this.config.currentProfile.total_classes) * 100) : 0
        },
        dates: {
            activation: this.config.currentProfile.activation_date,
            expiration: this.config.currentProfile.expiration_date,
            last_visit: this.config.currentProfile.last_visit_date,
            purchase: this.config.currentProfile.purchase_date  // ← ДОБАВЛЕНО
        }
    },
    rawData: {  // ← ДОБАВЛЕНО
        lead_data: this.config.currentProfile.lead_data,
        visits_data: this.config.currentProfile.visits_data
    }
};
                    
                    this.saveSession();
                    this.showMainInterface();
                    this.showNotification('✅ Вход выполнен успешно!', 'success');
                    this.navigateToPage('home');
                    this.loadHomePage();
                    
                    this.setupNotifications();
                } else {
                    throw new Error(data.error || 'Не удалось получить данные');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка входа:', error);
                this.showNotification('Ошибка: ' + error.message, 'error');
            })
            .finally(() => {
                this.hideLoading();
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Войти';
            });
        },

        // НАСТРОЙКА УВЕДОМЛЕНИЙ
        setupNotifications: function() {
            if (!this.config.token || !this.config.currentProfile) return;
            
            console.log('🔔 Настройка уведомлений...');
            
            const checkNotifications = () => {
                fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${this.config.token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data.notifications) {
                        data.data.notifications.forEach(notification => {
                            this.showNotification(notification.message, 'info');
                        });
                    }
                })
                .catch(error => {
                    console.error('❌ Ошибка получения уведомлений:', error);
                });
            };
            
            this.config.notificationInterval = setInterval(checkNotifications, 30000);
            checkNotifications();
        },

        // ЗАГРУЗКА ЛОГОТИПА
        loadAppLogo: function() {
            fetch('/api/logo?' + Date.now())
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    this.updateLogoInUI(data.data);
                }
            })
            .catch(error => {
                console.log('⚠️ Используется стандартный логотип');
            });
        },

        updateLogoInUI: function(logoData) {
            const authLogo = document.getElementById('authLogo');
            const logoTexts = document.querySelectorAll('.logo-text, .auth-logo-text');
            
            if (logoData.logo && logoData.logo.startsWith('data:image')) {
                if (authLogo) {
                    authLogo.innerHTML = `<img src="${logoData.logo}" alt="${logoData.name || 'БАНЯ'}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    authLogo.style.background = 'none';
                }
            }
            
            if (logoData.name) {
                logoTexts.forEach(el => {
                    el.textContent = logoData.name;
                });
            }
        },

        // ОБНОВЛЕНИЕ ИНФОРМАЦИИ ПОЛЬЗОВАТЕЛЯ
        updateUserInfo: function() {
            if (!this.config.currentProfile) {
                console.log('⚠️ Нет текущего профиля для отображения');
                return;
            }
            
            const profile = this.config.currentProfile;
            const currentHour = new Date().getHours();
            let greeting = 'Добро пожаловать';
            
            if (currentHour < 12) greeting = 'Доброе утро';
            else if (currentHour < 18) greeting = 'Добрый день';
            else greeting = 'Добрый вечер';
            
            document.getElementById('greeting').textContent = greeting;
            document.getElementById('studentGreetingName').textContent = profile.student_name || 'Ученик';
            
            let studentInfo = '';
            if (profile.branch) studentInfo += `Филиал: ${profile.branch}<br>`;
            if (profile.age_group) studentInfo += `Возрастная группа: ${profile.age_group}<br>`;
            if (profile.teacher_name) studentInfo += `Преподаватель: ${profile.teacher_name}`;
            
            if (!studentInfo) studentInfo = 'Информация загружается...';
            
            document.getElementById('studentDetailsInfo').innerHTML = studentInfo;
            
            this.updateContactInfo();
        },

        // ОБНОВЛЕНИЕ КОНТАКТНОЙ ИНФОРМАЦИИ
        updateContactInfo: function() {
            if (!this.config.currentProfile) return;
            
            const branch = this.config.currentProfile.branch;
            let phone = this.config.branchContacts['all'];
            
            if (branch && this.config.branchContacts[branch]) {
                phone = this.config.branchContacts[branch];
            }
            
            document.getElementById('phoneInfo').innerHTML = `
                <strong>${branch || 'Общий'}:</strong> ${phone}<br>
                <small>Телефон администратора</small>
            `;
        },

        // ЗАГРУЗКА ГЛАВНОЙ СТРАНИЦЫ
        loadHomePage: function() {
            console.log('🏠 ЗАГРУЗКА ГЛАВНОЙ СТРАНИЦЫ');
            
            if (!this.config.token) {
                this.showNotification('Требуется авторизация', 'error');
                this.showAuthPage();
                return;
            }
            
            this.updateUserInfo();
        },
// НОВЫЙ МЕТОД: Обновление данных ученика из сервера
refreshProfileData: function(studentName) {
    if (!studentName || !this.config.token) return;
    
    this.showLoading('Обновление данных ученика...');
    
    // Используем телефон текущего профиля для синхронизации
    const phone = this.config.currentProfile?.phone_number;
    if (!phone) {
        this.hideLoading();
        return;
    }
    
    // Запрашиваем синхронизацию данных с сервера
    fetch(`/api/sync/${encodeURIComponent(phone)}?force=true`, {
        headers: {
            'Authorization': `Bearer ${this.config.token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.profiles) {
            // Находим обновленный профиль по имени ученика
            const updatedProfile = data.profiles.find(p => p.student_name === studentName);
            
            if (updatedProfile) {
                // Обновляем профиль в списке
                const index = this.config.profiles.findIndex(p => p.student_name === studentName);
                if (index !== -1) {
                    this.config.profiles[index] = updatedProfile;
                    this.config.currentProfile = updatedProfile;
                    
                    // Обновляем subscriptionData
                    this.config.subscriptionData = {
                        student: {
                            name: updatedProfile.student_name,
                            branch: updatedProfile.branch,
                            teacher_name: updatedProfile.teacher_name,
                            age_group: updatedProfile.age_group,
                            parent_name: updatedProfile.parent_name,
                            phone_number: updatedProfile.phone_number
                        },
                        subscription: {
                            type: updatedProfile.subscription_type,
                            status: updatedProfile.subscription_status,
                            active: updatedProfile.subscription_active === 1,
                            badge: updatedProfile.subscription_badge,
                            classes: {
                                total: updatedProfile.total_classes,
                                used: updatedProfile.used_classes,
                                remaining: updatedProfile.remaining_classes,
                                progress: updatedProfile.total_classes > 0 ? 
                                    Math.round((updatedProfile.used_classes / updatedProfile.total_classes) * 100) : 0
                            },
                            dates: {
                                activation: updatedProfile.activation_date,
                                expiration: updatedProfile.expiration_date,
                                last_visit: updatedProfile.last_visit_date,
                                purchase: updatedProfile.purchase_date
                            }
                        },
                        rawData: {
                            lead_data: updatedProfile.lead_data,
                            visits_data: updatedProfile.visits_data
                        }
                    };
                    
                    this.saveSession();
                    this.showNotification(`✅ Данные для ${studentName} обновлены`, 'success');
                    
                    // Перерисовываем текущую страницу
                    this.loadPageData(this.config.currentPage);
                }
            }
        }
    })
    .catch(error => {
        console.error('❌ Ошибка обновления данных:', error);
        this.showNotification('Используем локальные данные', 'info');
    })
    .finally(() => {
        this.hideLoading();
    });
},
       // ВЫБОР УЧЕНИКА - ИСПРАВЛЕННАЯ ВЕРСИЯ
selectStudent: function(studentName) {
    if (!studentName) return;
    
    const profile = this.config.profiles.find(p => p.student_name === studentName);
    if (!profile) {
        this.showNotification('Профиль не найден', 'error');
        return;
    }
    
    this.config.currentProfile = profile;
    
    // Создаем обновленный subscriptionData для выбранного ученика
    this.config.subscriptionData = {
        student: {
            name: profile.student_name,
            branch: profile.branch,
            teacher_name: profile.teacher_name,
            age_group: profile.age_group,
            parent_name: profile.parent_name,
            phone_number: profile.phone_number  // ← ДОБАВЛЕНО: телефон для запросов
        },
        subscription: {
            type: profile.subscription_type,
            status: profile.subscription_status,
            active: profile.subscription_active === 1, // ← ИСПРАВЛЕНО: преобразование в boolean
            badge: profile.subscription_badge,
            classes: {
                total: profile.total_classes,
                used: profile.used_classes,
                remaining: profile.remaining_classes,
                progress: profile.total_classes > 0 ? 
                    Math.round((profile.used_classes / profile.total_classes) * 100) : 0
            },
            dates: {
                activation: profile.activation_date,
                expiration: profile.expiration_date,
                last_visit: profile.last_visit_date,
                purchase: profile.purchase_date // ← ДОБАВЛЕНО: дата покупки
            }
        },
        rawData: { // ← ДОБАВЛЕНО: сырые данные для посещений
            lead_data: profile.lead_data,
            visits_data: profile.visits_data
        }
    };
    
    this.updateUserInfo();
    this.showNotification(`Выбран ученик: ${profile.student_name}`, 'success');
    this.saveSession();
    
    // Перезагружаем данные для текущей страницы
    this.loadPageData(this.config.currentPage);
    
    // Очищаем историю посещений при смене ученика
    this.visitsHistory.visits = [];
    this.visitsHistory.currentPage = 1;
    
    // Если на странице абонемента, перезагружаем
    if (this.config.currentPage === 'subscription') {
        this.loadSubscriptionPage();
    }
},

        // НАВИГАЦИЯ ПО СТРАНИЦАМ
        navigateTo: function(pageName) {
            this.navigateToPage(pageName);
        },

        navigateToPage: function(pageName) {
            console.log(`📍 Навигация на страницу: ${pageName}`);
            
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) {
                    item.classList.add('active');
                }
            });
            
            const pageElement = document.getElementById(`${pageName}Page`);
            if (pageElement) {
                pageElement.classList.add('active');
                this.config.currentPage = pageName;
                this.loadPageData(pageName);
            }
        },

        // ЗАГРУЗКА ДАННЫХ ДЛЯ СТРАНИЦЫ
        loadPageData: function(pageName) {
            switch(pageName) {
                case 'home':
                    this.loadHomePage();
                    break;
                case 'subscription':
                    this.loadSubscriptionPage();
                    break;
                case 'schedule':
                    this.loadSchedulePage();
                    break;
                case 'teachers':
                    this.loadTeachersPage();
                    break;
                case 'faq':
                    this.loadFaqPage();
                    break;
                case 'news':
                    this.loadNewsPage();
                    break;
                case 'contact':
                    this.loadContactPage();
                    break;
            }
        },

        // ЗАГРУЗКА СТРАНИЦЫ АБОНЕМЕНТА
        loadSubscriptionPage: function() {
            const container = document.getElementById('subscriptionContainer');
            
            if (!this.config.currentProfile) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Нет активного профиля</p>
                    </div>
                `;
                return;
            }
            
            if (this.config.subscriptionData) {
                this.renderSubscription(this.config.subscriptionData);
                setTimeout(() => {
                    this.loadVisitsHistoryForWindow();
                }, 100);
                return;
            }
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="spinner"></div>
                    <p>Загрузка данных абонемента...</p>
                </div>
            `;
            
            this.loadSubscriptionFromAPI();
        },

        // ЗАГРУЗКА ДАННЫХ АБОНЕМЕНТА ИЗ API
        loadSubscriptionFromAPI: function() {
            if (!this.config.token) {
                this.showNotification('Требуется авторизация', 'error');
                return;
            }
            
            fetch('/api/profiles', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${this.config.token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.profiles) {
                    const currentProfileName = this.config.currentProfile.student_name;
                    const updatedProfile = data.data.profiles.find(p => p.student_name === currentProfileName);
                    
                    if (updatedProfile) {
                        this.config.currentProfile = updatedProfile;
                        
                        this.config.subscriptionData = {
                            student: {
                                name: updatedProfile.student_name,
                                branch: updatedProfile.branch,
                                teacher_name: updatedProfile.teacher_name,
                                age_group: updatedProfile.age_group,
                                parent_name: updatedProfile.parent_name
                            },
                            subscription: {
                                type: updatedProfile.subscription_type,
                                status: updatedProfile.subscription_status,
                                active: updatedProfile.subscription_active,
                                badge: updatedProfile.subscription_badge,
                                classes: {
                                    total: updatedProfile.total_classes,
                                    used: updatedProfile.used_classes,
                                    remaining: updatedProfile.remaining_classes,
                                    progress: updatedProfile.total_classes > 0 ? 
                                        Math.round((updatedProfile.used_classes / updatedProfile.total_classes) * 100) : 0
                                },
                                dates: {
                                    activation: updatedProfile.activation_date,
                                    expiration: updatedProfile.expiration_date,
                                    last_visit: updatedProfile.last_visit_date
                                }
                            }
                        };
                        
                        this.renderSubscription(this.config.subscriptionData);
                        this.saveSession();
                        this.showNotification('✅ Данные абонемента обновлены', 'success');
                    }
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки абонемента:', error);
                this.showNotification('Ошибка загрузки данных', 'error');
            });
        },

        // ОБНОВЛЕННЫЙ МЕТОД ЗАГРУЗКИ ИСТОРИИ ПОСЕЩЕНИЙ
loadVisitsHistoryForWindow: function() {
    if (!this.config.currentProfile) {
        this.showNoVisitsMessageInWindow();
        return;
    }
    
    // Используем телефон текущего профиля
    const phone = this.config.currentProfile.phone_number;
    if (!phone) {
        console.error('❌ Нет телефона у профиля:', this.config.currentProfile);
        this.showNoVisitsMessageInWindow();
        return;
    }
    
    this.showLoading(`Загрузка истории посещений для ${this.config.currentProfile.student_name}...`);
    
    // Используем новый API для посещений
    fetch(`/api/student/visits/${encodeURIComponent(phone)}`, {
        headers: {
            'Authorization': `Bearer ${this.config.token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data.visits.length > 0) {
            this.visitsHistory.visits = data.data.visits;
            this.visitsHistory.totalPages = Math.ceil(
                data.data.visits.length / this.visitsHistory.itemsPerPage
            );
            
            this.showVisitsWindow();
            this.renderVisitsForCurrentPage();
            this.updateVisitsPagination();
            
            // Обновляем статистику в subscriptionData
            if (this.config.subscriptionData) {
                this.config.subscriptionData.subscription.classes.used = data.data.total_visits || 0;
                this.config.subscriptionData.subscription.classes.remaining = data.data.remaining_classes || 0;
                
                // Пересчитываем прогресс
                const total = this.config.subscriptionData.subscription.classes.total || 0;
                const used = this.config.subscriptionData.subscription.classes.used || 0;
                if (total > 0) {
                    this.config.subscriptionData.subscription.classes.progress = Math.round((used / total) * 100);
                }
            }
        } else {
            this.showNoVisitsMessageInWindow();
        }
    })
    .catch(error => {
        console.error('❌ Ошибка загрузки истории:', error);
        this.showVisitsError(error);
    })
    .finally(() => {
        this.hideLoading();
    });
},

        // ПОКАЗАТЬ ОКОШКО ИСТОРИИ
        showVisitsWindow: function() {
            const windowElement = document.getElementById('visitsHistoryWindow');
            if (windowElement) {
                windowElement.style.display = 'block';
            }
        },

        // ОБНОВИТЬ СТАТИСТИКУ ПОСЕЩЕНИЙ - ФУНКЦИЯ УБРАНА, ТАК КАК БЛОК УДАЛЕН
        
        // РЕНДЕРИНГ ПОСЕЩЕНИЙ ДЛЯ ТЕКУЩЕЙ СТРАНИЦЫ
        renderVisitsForCurrentPage: function() {
            const container = document.getElementById('visitsListContainer');
            if (!container) return;
            
            const startIndex = (this.visitsHistory.currentPage - 1) * this.visitsHistory.itemsPerPage;
            const endIndex = startIndex + this.visitsHistory.itemsPerPage;
            const currentVisits = this.visitsHistory.visits.slice(startIndex, endIndex);
            
            if (currentVisits.length === 0) {
                this.showNoVisitsMessageInWindow();
                return;
            }
            
            let html = '';
            
            currentVisits.forEach((visit, index) => {
                const globalIndex = startIndex + index + 1;
                const dateDisplay = visit.formatted_date || 'Дата не указана';
                const isEstimated = visit.estimated || visit.source === 'estimated';
                const timeDisplay = visit.time || 'Время не указано';
                const teacherName = visit.teacher_name || 'Преподаватель не указан';
                const branchName = visit.branch || 'Филиал не указан';
                const groupName = visit.group_name || 'Группа не указана';
                const lessonNumber = visit.lesson_number ? `Занятие ${visit.lesson_number}` : '';
                
                html += `
                    <div class="visit-item ${isEstimated ? 'estimated' : ''}">
                        <div class="visit-date">
                            <i class="fas fa-calendar-alt"></i>
                            <span>${dateDisplay}</span>
                            ${isEstimated ? 
                              '<span class="badge badge-warning" style="margin-left: auto; font-size: 0.7rem; padding: 2px 8px;">оценка</span>' : 
                              '<span class="badge badge-success" style="margin-left: auto; font-size: 0.7rem; padding: 2px 8px;">подтверждено</span>'}
                        </div>
                        
                        <div style="font-size: 0.9rem; color: var(--gray-dark); margin-bottom: 5px;">
                            <i class="fas fa-clock"></i> ${timeDisplay}
                        </div>
                        
                        <div class="visit-details">
                            <div class="visit-detail">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <span>${teacherName}</span>
                            </div>
                            <div class="visit-detail">
                                <i class="fas fa-school"></i>
                                <span>${branchName}</span>
                            </div>
                            ${groupName ? `
                            <div class="visit-detail">
                                <i class="fas fa-users"></i>
                                <span>${groupName}</span>
                            </div>
                            ` : ''}
                            ${lessonNumber ? `
                            <div class="visit-detail">
                                <i class="fas fa-graduation-cap"></i>
                                <span>${lessonNumber}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },

        // ОБНОВИТЬ ПАГИНАЦИЮ
        updateVisitsPagination: function() {
            const pagination = document.getElementById('visitsPagination');
            const prevBtn = document.getElementById('prevVisitsPageBtn');
            const nextBtn = document.getElementById('nextVisitsPageBtn');
            const pageInfo = document.getElementById('visitsPageInfo');
            
            if (!pagination || !prevBtn || !nextBtn || !pageInfo) return;
            
            const totalPages = this.visitsHistory.totalPages;
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                prevBtn.disabled = this.visitsHistory.currentPage <= 1;
                nextBtn.disabled = this.visitsHistory.currentPage >= totalPages;
                pageInfo.textContent = `Страница ${this.visitsHistory.currentPage} из ${totalPages}`;
            } else {
                pagination.style.display = 'none';
            }
        },

        // ПРЕДЫДУЩАЯ СТРАНИЦА ПОСЕЩЕНИЙ
        prevVisitsPage: function() {
            if (this.visitsHistory.currentPage > 1) {
                this.visitsHistory.currentPage--;
                this.renderVisitsForCurrentPage();
                this.updateVisitsPagination();
            }
        },

        // СЛЕДУЮЩАЯ СТРАНИЦА ПОСЕЩЕНИЙ
        nextVisitsPage: function() {
            if (this.visitsHistory.currentPage < this.visitsHistory.totalPages) {
                this.visitsHistory.currentPage++;
                this.renderVisitsForCurrentPage();
                this.updateVisitsPagination();
            }
        },

        // ОБНОВИТЬ ИСТОРИЮ ПОСЕЩЕНИЙ
        refreshVisitsHistory: function() {
            this.showNotification('Обновление истории посещений...', 'success');
            this.visitsHistory.currentPage = 1;
            this.loadVisitsHistoryForWindow();
        },

        // СООБЩЕНИЕ "НЕТ ПОСЕЩЕНИЙ"
        showNoVisitsMessageInWindow: function() {
            const container = document.getElementById('visitsListContainer');
            const windowElement = document.getElementById('visitsHistoryWindow');
            
            if (container) {
                container.innerHTML = `
                    <div class="visits-empty-state">
                        <i class="fas fa-history"></i>
                        <p>История посещений пока пуста</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            Здесь будут отображаться все посещённые занятия
                        </p>
                    </div>
                `;
            }
            
            if (windowElement) {
                windowElement.style.display = 'block';
            }
        },

        // СООБЩЕНИЕ ОБ ОШИБКЕ
        showVisitsError: function(error) {
            const container = document.getElementById('visitsListContainer');
            if (container) {
                container.innerHTML = `
                    <div class="visits-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Ошибка загрузки истории</p>
                        <p style="font-size: 0.8rem; margin-top: 10px;">${error.message || 'Неизвестная ошибка'}</p>
                        <button class="btn btn-secondary mt-20" onclick="BanyaApp.refreshVisitsHistory()">
                            <i class="fas fa-redo"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
            
            const windowElement = document.getElementById('visitsHistoryWindow');
            if (windowElement) {
                windowElement.style.display = 'block';
            }
        },

      // ОБНОВЛЕННЫЙ РЕНДЕРИНГ АБОНЕМЕНТА
renderSubscription: function(subscriptionData) {
    const container = document.getElementById('subscriptionContainer');
    
    if (!subscriptionData || !subscriptionData.subscription) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Нет данных об абонементе</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">
                    Ученик: ${this.config.currentProfile?.student_name || 'Не выбран'}
                </p>
            </div>
        `;
        return;
    }
    
    const student = subscriptionData.student || {};
    const subscription = subscriptionData.subscription;
    
    const total = subscription.classes?.total || 0;
    const remaining = subscription.classes?.remaining || 0;
    const used = subscription.classes?.used || 0;
    const progress = subscription.classes?.progress || 0;
    
    let statusClass = 'badge-error';
    if (subscription.active) statusClass = 'badge-success';
    else if (subscription.badge === 'pending') statusClass = 'badge-warning';
    
    container.innerHTML = `
        <div class="subscription-card">
            <div class="subscription-header">
                <div>
                    <div class="subscription-type">${subscription.type || 'Абонемент'}</div>
                    <div class="subscription-branch">
                        <i class="fas fa-user-graduate"></i> ${student.name || 'Ученик'}
                        ${student.branch ? ` • ${student.branch}` : ''}
                    </div>
                </div>
                <div class="badge ${statusClass}">
                    ${subscription.active ? 'Активен' : subscription.status || 'Не активен'}
                </div>
            </div>
            
            <div class="subscription-stats">
                <div class="stat-item">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Всего занятий</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-value" style="color: ${remaining > 0 ? 'white' : '#ff6b6b'}">
                        ${remaining}
                    </div>
                    <div class="stat-label">Осталось</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-value">${used}</div>
                    <div class="stat-label">Использовано</div>
                </div>
            </div>
            
            ${total > 0 ? `
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <div style="text-align: center; font-size: 0.9rem; opacity: 0.9;">
                Прогресс: ${progress}%
            </div>
            ` : ''}
            
            <div class="dates-info">
                <div class="date-item">
                    <div class="date-label">Дата активации</div>
                    <div class="date-value">${this.formatDate(subscription.dates?.activation) || 'Не указана'}</div>
                </div>
                <div class="date-item">
                    <div class="date-label">Срок действия</div>
                    <div class="date-value">${this.formatDate(subscription.dates?.expiration) || 'Не указан'}</div>
                </div>
                <!-- ДОБАВЛЕНА ДАТА ПОКУПКИ -->
                <div class="date-item">
                    <div class="date-label">Дата покупки</div>
                    <div class="date-value">${this.formatDate(subscription.dates?.purchase) || 'Не указана'}</div>
                </div>
            </div>
            
            ${subscription.dates?.last_visit ? `
            <div class="date-item" style="margin-top: 10px;">
                <div class="date-label">Последний визит</div>
                <div class="date-value">${this.formatDate(subscription.dates.last_visit)}</div>
            </div>
            ` : ''}
        </div>
    `;
    
    setTimeout(() => {
        this.loadVisitsHistoryForWindow();
    }, 100);
},
        // ОБНОВЛЕНИЕ ДАННЫХ АБОНЕМЕНТА
        refreshSubscription: function() {
            this.showNotification('Обновление данных...', 'success');
            this.config.subscriptionData = null;
            this.loadSubscriptionFromAPI();
        },

        // ЗАГРУЗКА СТРАНИЦЫ РАСПИСАНИЯ
        loadSchedulePage: function() {
            const container = document.getElementById('scheduleContainer');
            const branchBadge = document.getElementById('branchBadge');
            
            if (!this.config.currentProfile) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Нет активного профиля</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            const branch = this.config.currentProfile.branch;
            
            if (!branch) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>Филиал не указан в профиле</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            branchBadge.textContent = `Филиал: ${branch}`;
            branchBadge.style.display = 'inline-block';
            
            this.loadScheduleFromAPI(branch);
        },

        // ЗАГРУЗКА РАСПИСАНИЯ ИЗ API
        loadScheduleFromAPI: function(branch) {
            const container = document.getElementById('scheduleContainer');
            
            console.log(`📅 Загрузка расписания для филиала: ${branch}`);
            
            this.showLoading('Загрузка расписания...');
            
            const encodedBranch = encodeURIComponent(branch);
            
            fetch(`/api/schedule/${encodedBranch}`, {
                headers: {
                    'Authorization': `Bearer ${this.config.token}`
                }
            })
            .then(response => {
                console.log('📊 Ответ сервера:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 Данные расписания получены:', data);
                
                if (data.success && data.data && data.data.schedule) {
                    this.renderSchedule(data.data.schedule);
                } else {
                    throw new Error(data.error || 'Ошибка загрузки расписания');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки расписания:', error);
                this.showNotification('Ошибка загрузки расписания', 'error');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>Не удалось загрузить расписание</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                        <button class="btn btn-secondary mt-20" onclick="BanyaApp.loadPageData('schedule')">
                            <i class="fas fa-redo"></i> Попробовать снова
                        </button>
                    </div>
                `;
            })
            .finally(() => {
                this.hideLoading();
            });
        },

        // РЕНДЕРИНГ РАСПИСАНИЯ
        renderSchedule: function(scheduleData) {
            const container = document.getElementById('scheduleContainer');
            
            console.log('📊 Данные для рендеринга:', scheduleData);
            
            if (!scheduleData || !Array.isArray(scheduleData) || scheduleData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar"></i>
                        <p>Расписание пока не составлено</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Занятий на ближайшие дни не запланировано</p>
                        <button class="btn btn-secondary mt-20" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> Обновить
                        </button>
                    </div>
                `;
                return;
            }
            
            const scheduleByDay = {};
            
            scheduleData.forEach(lesson => {
                const date = lesson.date || '';
                const dayName = this.formatDateForSchedule(date);
                
                if (!scheduleByDay[dayName]) {
                    scheduleByDay[dayName] = [];
                }
                
                scheduleByDay[dayName].push({
                    id: lesson.id,
                    time: lesson.time || 'Время не указано',
                    teacher: lesson.teacher_name || 'Преподаватель не указан',
                    group: lesson.group_name || '',
                    ageGroup: lesson.age_group || '',
                    status: {
                        type: lesson.status === 'cancelled' ? 'cancelled' : 'normal',
                        text: lesson.status === 'cancelled' ? 'Отменено' : 'Запланировано'
                    }
                });
            });
            
            const sortedDays = Object.keys(scheduleByDay).sort((a, b) => {
                return new Date(a.split(', ')[1] || a) - new Date(b.split(', ')[1] || b);
            });
            
            let html = '';
            
            sortedDays.forEach(day => {
                html += `
                    <div class="schedule-day">
                        <div class="day-header">${day}</div>
                `;
                
                scheduleByDay[day].forEach(lesson => {
                    html += `
                        <div class="lesson-item ${lesson.status.type}">
                            <div class="lesson-time">${lesson.time}</div>
                            <div class="lesson-details">
                                <div class="lesson-teacher">
                                    <i class="fas fa-chalkboard-teacher"></i> ${lesson.teacher}
                                </div>
                                <div class="lesson-status status-${lesson.status.type}">
                                    ${lesson.status.text}
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray-dark);">
                                ${lesson.group} ${lesson.group && lesson.ageGroup ? '•' : ''} ${lesson.ageGroup || ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            
            if (sortedDays.length > 0) {
                container.innerHTML += `
                    <div class="mt-20 text-center">
                        <p style="color: var(--gray-dark); font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            Всего занятий: ${scheduleData.length}
                        </p>
                    </div>
                `;
            }
        },

        formatDateForSchedule: function(dateString) {
            if (!dateString) return 'Дата не указана';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                const dayName = days[date.getDay()];
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                
                return `${dayName}, ${day}.${month}`;
            } catch (error) {
                return dateString;
            }
        },

        // ЗАГРУЗКА СТРАНИЦЫ ПРЕПОДАВАТЕЛЕЙ
        loadTeachersPage: function() {
            const container = document.getElementById('teachersContainer');
            const branchBadge = document.getElementById('branchBadgeTeachers');
            
            if (!this.config.currentProfile) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Нет активного профиля</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            const branch = this.config.currentProfile.branch;
            
            if (!branch) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>Филиал не указан в профиле</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            branchBadge.textContent = `Филиал: ${branch}`;
            branchBadge.style.display = 'inline-block';
            
            this.loadTeachersFromAPI(branch);
        },

        // ЗАГРУЗКА ПРЕПОДАВАТЕЛЕЙ ИЗ API
        loadTeachersFromAPI: function(branch) {
            const container = document.getElementById('teachersContainer');
            
            this.showLoading('Загрузка преподавателей...');
            
            fetch(`/api/teachers/student/${encodeURIComponent(branch)}`, {
                headers: {
                    'Authorization': `Bearer ${this.config.token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.teachers) {
                    this.renderTeachers(data.data.teachers);
                } else {
                    throw new Error(data.error || 'Ошибка загрузки преподавателей');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки преподавателей:', error);
                this.showNotification('Ошибка загрузки преподавателей', 'error');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>В вашем филиале преподаватели не найдены</p>
                    </div>
                `;
            })
            .finally(() => {
                this.hideLoading();
            });
        },

        // РЕНДЕРИНГ ПРЕПОДАВАТЕЛЕЙ
        renderTeachers: function(teachers) {
            const container = document.getElementById('teachersContainer');
            
            if (!teachers || teachers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>В вашем филиале преподаватели не найдены</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            teachers.forEach(teacher => {
                html += `
                    <div class="teacher-card">
                        <div class="teacher-photo">
                            ${this.getInitials(teacher.name)}
                        </div>
                        <div class="teacher-name">${teacher.name}</div>
                        <div class="teacher-specialization">${teacher.specialization}</div>
                        <div style="margin-top: 10px; font-size: 0.8rem; color: var(--gray-dark);">
                            <i class="fas fa-award"></i> Стаж: ${teacher.experience} лет
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },

        // ЗАГРУЗКА СТРАНИЦЫ FAQ
        loadFaqPage: function() {
            const container = document.getElementById('faqContainer');
            
            this.showLoading('Загрузка FAQ...');
            
            fetch('/api/faq/student', {
                headers: {
                    'Authorization': `Bearer ${this.config.token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.faq) {
                    this.renderFaq(data.data.faq);
                } else {
                    throw new Error(data.error || 'Ошибка загрузки FAQ');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки FAQ:', error);
                this.showNotification('Ошибка загрузки FAQ', 'error');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-question-circle"></i>
                        <p>Вопросы пока не добавлены</p>
                    </div>
                `;
            })
            .finally(() => {
                this.hideLoading();
            });
        },

        // РЕНДЕРИНГ FAQ
        renderFaq: function(faq) {
            const container = document.getElementById('faqContainer');
            
            if (!faq || faq.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-question-circle"></i>
                        <p>Вопросы пока не добавлены</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            faq.forEach((item, index) => {
                html += `
                    <div class="faq-item" id="faq-${index}">
                        <div class="faq-question" onclick="BanyaApp.toggleFaq(${index})">
                            ${item.question}
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            ${item.answer}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },

        // ПЕРЕКЛЮЧЕНИЕ FAQ
        toggleFaq: function(index) {
            const faqItem = document.getElementById(`faq-${index}`);
            faqItem.classList.toggle('active');
        },

        // ЗАГРУЗКА СТРАНИЦЫ НОВОСТЕЙ
        loadNewsPage: function() {
            const container = document.getElementById('newsContainer');
            const branchBadge = document.getElementById('branchBadgeNews');
            
            if (!this.config.currentProfile) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Нет активного профиля</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            const branch = this.config.currentProfile.branch;
            
            if (!branch) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>Филиал не указан в профиле</p>
                    </div>
                `;
                branchBadge.style.display = 'none';
                return;
            }
            
            branchBadge.textContent = `Филиал: ${branch}`;
            branchBadge.style.display = 'inline-block';
            
            this.loadNewsFromAPI(branch);
        },

        // ЗАГРУЗКА НОВОСТЕЙ ИЗ API
        loadNewsFromAPI: function(branch) {
            const container = document.getElementById('newsContainer');
            
            this.showLoading('Загрузка новостей...');
            
            fetch(`/api/news/${encodeURIComponent(branch)}`, {
                headers: {
                    'Authorization': `Bearer ${this.config.token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.news) {
                    this.renderNews(data.data.news);
                } else {
                    throw new Error(data.error || 'Ошибка загрузки новостей');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки новостей:', error);
                this.showNotification('Ошибка загрузки новостей', 'error');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-newspaper"></i>
                        <p>Новостей для вашего филиала пока нет</p>
                    </div>
                `;
            })
            .finally(() => {
                this.hideLoading();
            });
        },

        // РЕНДЕРИНГ НОВОСТЕЙ
        renderNews: function(news) {
            const container = document.getElementById('newsContainer');
            
            if (!news || news.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-newspaper"></i>
                        <p>Новостей для вашего филиала пока нет</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            news.forEach(item => {
                html += `
                    <div class="news-item">
                        <div class="news-date">
                            <i class="far fa-calendar"></i> ${item.date}
                        </div>
                        <div class="news-title">${item.title}</div>
                        <div class="news-content news-content-short">
                            ${item.content}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        },

        // ЗАГРУЗКА СТРАНИЦЫ КОНТАКТОВ
        loadContactPage: function() {
            this.updateContactInfo();
        },

        // СВЯЗЬ С АДМИНИСТРАТОРОМ
        contactAdmin: function(subject) {
            const message = `Здравствуйте!\n\nПрошу связаться со мной по вопросу: ${subject || 'Вопрос по абонементу'}\n\nУченик: ${this.config.currentProfile?.student_name || ''}\nФилиал: ${this.config.currentProfile?.branch || ''}\n\nСпасибо!`;
            
            this.showLoading('Отправка сообщения...');
            
            fetch('/api/contact/admin', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.config.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: subject,
                    message: message,
                    student_name: this.config.currentProfile?.student_name || '',
                    branch: this.config.currentProfile?.branch || ''
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    this.showNotification('✅ Сообщение отправлено администратору', 'success');
                } else {
                    throw new Error(data.error || 'Ошибка отправки сообщения');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка отправки сообщения:', error);
                this.showNotification('Ошибка отправки сообщения: ' + error.message, 'error');
            })
            .finally(() => {
                this.hideLoading();
            });
        },

        // ЗВОНОК АДМИНИСТРАТОРУ
        callAdmin: function() {
            const branch = this.config.currentProfile?.branch;
            let phone = this.config.branchContacts['all'];
            
            if (branch && this.config.branchContacts[branch]) {
                phone = this.config.branchContacts[branch];
            }
            
            if (confirm(`Позвонить администратору?\n\n${branch || 'Общий'}: ${phone}\n\nНажмите OK для звонка`)) {
                window.location.href = `tel:${phone.replace(/\D/g, '')}`;
            }
        },

        // ВЫХОД ИЗ СИСТЕМЫ
        logout: function() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                this.clearNotificationInterval();
                this.clearSession();
                this.showAuthPage();
                this.showNotification('Вы успешно вышли из системы', 'success');
            }
        },

        // ОЧИСТКА ИНТЕРВАЛА УВЕДОМЛЕНИЙ
        clearNotificationInterval: function() {
            if (this.config.notificationInterval) {
                clearInterval(this.config.notificationInterval);
                this.config.notificationInterval = null;
            }
        },

        // УВЕДОМЛЕНИЯ
        showNotification: function(message, type = 'success', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'error' ? 'exclamation-circle' : 
                         type === 'warning' ? 'exclamation-triangle' : 
                         type === 'success' ? 'check-circle' : 'info-circle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i> ${message}
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        },

        // ИНДИКАТОР ЗАГРУЗКИ
        showLoading: function(message) {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingText) loadingText.textContent = message || 'Загрузка...';
            if (loading) loading.classList.add('active');
        },

        hideLoading: function() {
            const loading = document.getElementById('loading');
            if (loading) loading.classList.remove('active');
        },

        // РАБОТА С СЕССИЕЙ
        saveSession: function() {
            try {
                const sessionData = {
                    token: this.config.token,
                    currentUser: this.config.currentUser,
                    currentProfile: this.config.currentProfile,
                    profiles: this.config.profiles,
                    subscriptionData: this.config.subscriptionData,
                    timestamp: Date.now()
                };
                
                console.log('💾 Сохраняем в сессию:', {
                    has_activation_date: !!this.config.currentProfile?.activation_date,
                    currentProfile: this.config.currentProfile
                });
                
                localStorage.setItem('banyaSchoolSession', JSON.stringify(sessionData));
            } catch (error) {
                console.error('Ошибка сохранения сессии:', error);
            }
        },

        loadSession: function() {
            try {
                const saved = localStorage.getItem('banyaSchoolSession');
                if (saved) {
                    const sessionData = JSON.parse(saved);
                    
                    const maxAge = 24 * 60 * 60 * 1000;
                    if (Date.now() - (sessionData.timestamp || 0) < maxAge) {
                        this.config.token = sessionData.token;
                        this.config.currentUser = sessionData.currentUser;
                        this.config.currentProfile = sessionData.currentProfile;
                        this.config.profiles = sessionData.profiles || [];
                        this.config.subscriptionData = sessionData.subscriptionData;
                        console.log('📂 Сессия загружена');
                        return true;
                    } else {
                        console.log('⌛ Сессия устарела, требуется повторная авторизация');
                        this.clearSession();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки сессии:', error);
                this.clearSession();
            }
            return false;
        },

        clearSession: function() {
            localStorage.removeItem('banyaSchoolSession');
            this.config.token = null;
            this.config.currentUser = null;
            this.config.currentProfile = null;
            this.config.profiles = [];
            this.config.subscriptionData = null;
            console.log('🗑️ Сессия очищена');
        },

        // УТИЛИТЫ
        getInitials: function(name) {
            if (!name || typeof name !== 'string') return 'У';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'У';
        },

        formatDate: function(dateString) {
            if (!dateString) return 'Не указано';
            
            try {
                if (/^\d+$/.test(dateString)) {
                    const timestamp = parseInt(dateString);
                    const date = timestamp < 10000000000 
                        ? new Date(timestamp * 1000)
                        : new Date(timestamp);
                    return date.toLocaleDateString('ru-RU');
                }
                
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                console.error('Ошибка форматирования даты:', error);
                return dateString;
            }
        },

        // НАСТРОЙКА ОБРАБОТЧИКОВ СОБЫТИЙ
        setupEventListeners: function() {
            const self = this;
            
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 0) {
                        value = value.substring(0, 11);
                    }
                    
                    if (value.length > 0) {
                        let formatted = '';
                        if (value.length > 0) formatted = value.substring(0, 1);
                        if (value.length > 1) formatted += ' ' + value.substring(1, 4);
                        if (value.length > 4) formatted += ' ' + value.substring(4, 7);
                        if (value.length > 7) formatted += '-' + value.substring(7, 9);
                        if (value.length > 9) formatted += '-' + value.substring(9, 11);
                        e.target.value = formatted;
                    }
                });
                
                phoneInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        self.handlePhoneLogin();
                    }
                });
            }
            
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    self.handlePhoneLogin();
                });
            }
        }
    };

    // ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ СТРАНИЦЫ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Приложение загружено, запуск...');
        BanyaApp.init();
    });

    // ДОСТУП К ГЛОБАЛЬНОМУ ОБЪЕКТУ
    window.BanyaApp = BanyaApp;
    </script>
</body>
</html>
